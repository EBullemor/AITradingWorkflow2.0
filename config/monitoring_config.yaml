# ===========================================
# Monitoring Configuration
# ===========================================
# Health check thresholds and alerting rules

# ----- Pipeline Health -----
pipeline:
  max_runtime_minutes: 30
  required_stages:
    - ingest
    - validate
    - features
    - signals
    - aggregate
    - risk
    - output
  
  # If any stage fails, what to do
  on_stage_failure:
    ingest: "halt"      # Can't continue without data
    validate: "halt"    # Can't use unvalidated data
    features: "halt"    # Strategies need features
    signals: "continue" # Can skip failed strategy pods
    aggregate: "halt"   # Need aggregation for dedup
    risk: "halt"        # Can't output without risk sizing
    output: "retry"     # Retry output failures

# ----- Data Health -----
data:
  max_stale_hours: 24
  min_instruments: 6           # Minimum instruments with valid data
  min_validation_pass_rate: 0.95  # 95% of data must pass validation
  
  alerts:
    stale_data: true
    missing_instruments: true
    low_validation_rate: true

# ----- Model Health -----
model:
  # Signal distribution monitoring
  signal_imbalance_threshold: 0.80  # >80% same direction = flag
  min_signals_per_week: 5           # At least 5 signals/week expected
  max_signals_per_day: 20           # More than this is suspicious
  
  # Confidence drift
  confidence_drift_threshold: 0.20  # 20% change from baseline
  confidence_baseline_window_days: 30
  
  # Strategy activation
  min_active_strategies: 2          # At least 2 strategies should fire weekly
  
  alerts:
    signal_imbalance: true
    no_signals: true
    confidence_drift: true
    strategy_inactive: true

# ----- LLM Health -----
llm:
  min_grounding_score: 0.85         # 85% of claims must be sourced
  max_api_latency_seconds: 30
  max_extraction_failures: 3        # Per day
  
  # Grounding score trend
  grounding_trend_window_days: 7
  grounding_decline_threshold: 0.10 # Alert if 10% decline over window
  
  alerts:
    low_grounding_score: true
    api_latency: true
    extraction_failures: true
    grounding_decline: true

# ----- Output Health -----
output:
  min_recommendations_per_day: 0    # 0 is warning, not failure
  max_recommendations_per_day: 15
  notion_timeout_seconds: 10
  slack_timeout_seconds: 5
  
  # Delivery tracking
  track_delivery_success: true
  retry_failed_deliveries: true
  max_retries: 3
  
  alerts:
    no_recommendations: true        # Warn if 0 recommendations
    delivery_failure: true
    excessive_recommendations: true

# ----- Alerting -----
alerts:
  # Slack webhook for alerts
  slack_webhook: "${SLACK_MONITORING_WEBHOOK}"
  
  # Alert levels
  levels:
    info: false     # Don't alert on info
    warning: true   # Alert on warnings
    error: true     # Alert on errors
    critical: true  # Always alert on critical
    
  # Quiet hours (don't alert overnight)
  quiet_hours:
    enabled: true
    start: "22:00"  # ET
    end: "06:00"    # ET
    
  # Escalation
  escalation:
    enabled: true
    escalate_after_minutes: 60     # If not acknowledged
    escalation_channel: "${SLACK_ESCALATION_WEBHOOK}"
    
  # Alert format
  include_in_alert:
    - check_name
    - status
    - details
    - suggested_action
    - dashboard_link

# ----- Health Check Schedule -----
schedule:
  # Run health checks after daily pipeline
  post_pipeline: true
  
  # Also run periodic checks
  periodic:
    enabled: true
    interval_minutes: 60  # Every hour during market hours
    
  # Market hours only
  market_hours_only: true
  market_hours:
    start: "06:00"  # ET
    end: "18:00"    # ET

# ----- Dashboard Export -----
dashboard:
  export_metrics: true
  export_path: "reports/health/metrics_{date}.json"
  
  metrics_to_export:
    - pipeline_status
    - data_freshness
    - signal_counts
    - grounding_scores
    - delivery_status
    - error_counts
