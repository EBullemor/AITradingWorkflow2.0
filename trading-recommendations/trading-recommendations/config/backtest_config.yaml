# ===========================================
# Backtest Configuration
# ===========================================
# Settings for strategy backtesting and validation

# ----- Validation Method -----
backtest:
  # Walk-forward validation (recommended) vs simple train/test split
  validation_method: "walk_forward"  # Options: walk_forward, train_test_split
  
  # Walk-Forward Settings
  walk_forward:
    train_window_days: 252    # 1 year training window
    test_window_days: 63      # 3 months testing window
    step_days: 21             # Roll forward monthly
    min_train_samples: 200    # Minimum trades in training period
    
  # Simple split (if not using walk-forward)
  train_test_split:
    train_ratio: 0.7
    
  # Date Range
  start_date: "2022-01-01"
  end_date: "2025-12-31"

# ----- Transaction Costs -----
# CRITICAL: Use realistic costs per asset class
transaction_costs:
  fx_majors:           # EURUSD, USDJPY, GBPUSD, AUDUSD
    spread_bps: 1.0    # 1 basis point spread
    slippage_bps: 0.5  # 0.5 bps slippage
    commission: 0.0    # No commission for spot FX
    
  fx_em:               # Emerging market FX (if added later)
    spread_bps: 5.0
    slippage_bps: 2.0
    commission: 0.0
    
  commodities:         # CL, GC, HG
    spread_bps: 3.0
    slippage_bps: 2.0
    commission_per_contract: 2.50
    
  btc:                 # BTCUSD
    spread_bps: 5.0
    slippage_bps: 5.0
    commission_pct: 0.10  # 10 bps commission

# ----- Position Sizing in Backtest -----
position_sizing:
  method: "fixed_risk"  # Options: fixed_risk, kelly, equal_weight
  risk_per_trade_pct: 1.0
  max_position_pct: 10.0
  
  # Kelly sizing (if using)
  kelly:
    fraction: 0.25  # Use 25% Kelly for safety
    min_trades_for_kelly: 50  # Need 50 trades before using Kelly

# ----- Data Handling -----
data:
  price_field: "adjusted_close"  # Use adjusted prices for splits/dividends
  fill_assumption: "next_open"   # Options: close, next_open, vwap
  handle_missing: "forward_fill" # Options: forward_fill, drop, interpolate
  
  # Survivorship bias
  include_delisted: true  # Include instruments that were delisted
  
  # Look-ahead bias prevention
  use_point_in_time: true  # Only use data available at decision time

# ----- Regime-Aware Evaluation -----
regime_analysis:
  enabled: true
  
  regimes:
    - name: "low_vol"
      condition: "vix_percentile < 0.30"
      
    - name: "high_vol"
      condition: "vix_percentile > 0.70"
      
    - name: "trending"
      condition: "abs(spx_momentum_3m) > 0.10"
      
    - name: "ranging"
      condition: "abs(spx_momentum_3m) <= 0.05"
      
  # Calculate metrics per regime
  calculate_per_regime:
    - sharpe_ratio
    - win_rate
    - avg_trade_pnl
    - max_drawdown

# ----- Metrics -----
metrics:
  primary:
    - sharpe_ratio
    - max_drawdown
    - cagr
    
  secondary:
    - win_rate
    - profit_factor
    - avg_trade_pnl
    - avg_winner
    - avg_loser
    - max_consecutive_losses
    - recovery_time
    
  # Calculate per regime
  per_regime: true
  
  # Confidence intervals
  confidence_intervals:
    enabled: true
    method: "bootstrap"
    n_samples: 1000
    ci_level: 0.95

# ----- Benchmarks -----
benchmarks:
  - name: "buy_and_hold_spy"
    description: "S&P 500 buy and hold"
    
  - name: "60_40"
    description: "60% stocks, 40% bonds"
    
  - name: "risk_parity"
    description: "Risk parity portfolio"

# ----- Reporting -----
reporting:
  output_dir: "reports/backtest/"
  
  generate:
    - summary_stats
    - equity_curve
    - drawdown_chart
    - monthly_returns
    - trade_log
    - regime_analysis
    
  formats:
    - json
    - html
    - csv  # For trade log
    
  # Charts
  generate_plots: true
  plot_format: "png"

# ----- Warnings -----
warnings:
  # Alert on potential issues
  low_trade_count: 30         # Warn if < 30 trades in test period
  high_turnover: 50           # Warn if > 50 trades/year
  negative_sharpe: true       # Warn if Sharpe < 0
  high_correlation_with_spy: 0.8  # Warn if corr > 0.8 (just tracking market)
  
  # Overfitting indicators
  train_test_gap: 0.5         # Warn if train Sharpe > 2x test Sharpe
  parameter_sensitivity: true # Flag if small param changes break strategy
